generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                    String    @id
  userId                String
  scope                 String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  accountId             String
  createdAt             DateTime  @default(now())
  idToken               String?
  password              String?
  providerId            String
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  updatedAt             DateTime
  User                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
}

model ActivityCatalog {
  id                 String         @id
  name               String         @unique
  category           String
  type               HRActivityType
  defaultPeriodicity HRPeriodicity?
  description        String?
  isActive           Boolean        @default(true)
  sortOrder          Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  HRActivity         HRActivity[]

  @@index([category])
  @@index([isActive])
  @@index([sortOrder])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([entityId])
  @@index([entity])
  @@index([userId])
}

model CompanySetting {
  id          String   @id
  key         String   @unique
  value       String
  type        String   @default("string")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([key])
}

model Conversation {
  id                 String               @id
  type               ConversationType
  name               String?
  projectId          String?
  createdBy          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  User               User?                @relation(fields: [createdBy], references: [id])
  Project            Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ConversationMember ConversationMember[]
  Message            Message[]

  @@index([createdAt])
  @@index([createdBy])
  @@index([projectId])
  @@index([type])
}

model ConversationMember {
  id             String       @id
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  isAdmin        Boolean      @default(false)
  isMuted        Boolean      @default(false)
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Department {
  id          String    @id
  name        String
  code        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Project     Project[]
  User        User[]

  @@index([code])
}

model HRActivity {
  id              String           @id
  hrTimesheetId   String
  activityType    HRActivityType
  activityName    String
  description     String?
  periodicity     HRPeriodicity
  weeklyQuantity  Int?
  startDate       DateTime
  endDate         DateTime
  totalHours      Float
  status          HRActivityStatus
  catalogId       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  taskId          String?
  priority        String?
  estimatedHours  Float?
  dueDate         DateTime?
  reminderDate    DateTime?
  reminderTime    String?
  soundEnabled    Boolean          @default(true)
  sharedWith      Json?
  complexity      TaskComplexity?
  ActivityCatalog ActivityCatalog? @relation(fields: [catalogId], references: [id])
  HRTimesheet     HRTimesheet      @relation(fields: [hrTimesheetId], references: [id], onDelete: Cascade)
  Task            Task?            @relation(fields: [taskId], references: [id])

  @@index([catalogId])
  @@index([hrTimesheetId])
  @@index([status])
  @@index([taskId])
}

model HRTimesheet {
  id                                       String            @id
  weekStartDate                            DateTime
  weekEndDate                              DateTime
  userId                                   String
  employeeName                             String
  position                                 String
  site                                     String
  totalHours                               Float             @default(0)
  status                                   HRTimesheetStatus @default(DRAFT)
  employeeSignedAt                         DateTime?
  managerSignedAt                          DateTime?
  managerSignedById                        String?
  odillonSignedAt                          DateTime?
  odillonSignedById                        String?
  employeeObservations                     String?
  managerComments                          String?
  odillonComments                          String?
  createdAt                                DateTime          @default(now())
  updatedAt                                DateTime
  HRActivity                               HRActivity[]
  Report                                   Report[]
  User_HRTimesheet_managerSignedByIdToUser User?             @relation("HRTimesheet_managerSignedByIdToUser", fields: [managerSignedById], references: [id])
  User_HRTimesheet_odillonSignedByIdToUser User?             @relation("HRTimesheet_odillonSignedByIdToUser", fields: [odillonSignedById], references: [id])
  User_HRTimesheet_userIdToUser            User              @relation("HRTimesheet_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)
  Task                                     Task[]

  @@unique([userId, weekStartDate])
  @@index([managerSignedById])
  @@index([status])
  @@index([userId])
  @@index([weekStartDate])
}

model Holiday {
  id          String   @id
  name        String
  date        DateTime
  description String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([date, name])
  @@index([date])
}

model Message {
  id             String       @id
  conversationId String
  senderId       String
  content        String
  attachments    Json?
  isEdited       Boolean      @default(false)
  isDeleted      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  replyToId      String?
  reactions      Json?
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  Message        Message?     @relation("MessageToMessage", fields: [replyToId], references: [id])
  other_Message  Message[]    @relation("MessageToMessage")
  User           User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([replyToId])
  @@index([senderId])
}

model Notification {
  id        String   @id
  userId    String
  title     String
  message   String
  type      String   @default("info")
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([userId])
}

model Project {
  id            String          @id
  name          String
  code          String          @unique
  description   String?
  color         String          @default("#3b82f6")
  departmentId  String?
  budgetHours   Float?
  hourlyRate    Float?
  isActive      Boolean         @default(true)
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  createdBy     String?
  Conversation  Conversation[]
  User          User?           @relation(fields: [createdBy], references: [id])
  Department    Department?     @relation(fields: [departmentId], references: [id])
  ProjectMember ProjectMember[]
  Task          Task[]

  @@index([code])
  @@index([createdBy])
  @@index([departmentId])
  @@index([isActive])
}

model ProjectMember {
  id        String   @id
  projectId String
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Report {
  id              String            @id
  title           String
  content         String
  format          String            @default("pdf")
  period          String?
  includeSummary  Boolean           @default(false)
  fileSize        Int               @default(0)
  createdById     String
  templateId      String?
  reportType      String?
  hrTimesheetId   String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  User            User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  ReportTemplate  ReportTemplate?   @relation(fields: [templateId], references: [id])
  HRTimesheet     HRTimesheet?      @relation(fields: [hrTimesheetId], references: [id])
  ReportRecipient ReportRecipient[]

  @@index([createdAt])
  @@index([createdById])
  @@index([templateId])
  @@index([hrTimesheetId])
}

model ReportRecipient {
  id       String   @id
  reportId String
  userId   String?
  email    String
  name     String?
  status   String   @default("sent")
  sentAt   DateTime @default(now())
  Report   Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  User     User?    @relation(fields: [userId], references: [id])

  @@index([email])
  @@index([reportId])
  @@index([userId])
}

model ReportTemplate {
  id              String          @id
  name            String
  description     String?
  frequency       ReportFrequency
  format          String          @default("word")
  templateContent String
  variables       Json?
  isActive        Boolean         @default(true)
  isDefault       Boolean         @default(false)
  sortOrder       Int             @default(0)
  createdById     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  User            User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  Report          Report[]

  @@index([frequency])
  @@index([isActive])
  @@index([isDefault])
  @@index([createdById])
}

model ReportType {
  id          String          @id
  name        String          @unique
  frequency   ReportFrequency
  description String?
  isActive    Boolean         @default(true)
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime

  @@index([frequency])
  @@index([isActive])
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Task {
  id                          String              @id
  name                        String
  description                 String?
  projectId                   String?
  parentId                    String?
  estimatedHours              Float?
  isActive                    Boolean             @default(true)
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime
  recurrence                  String?
  evaluatedBy                 String?
  evaluationNotes             String?
  evaluatedAt                 DateTime?
  createdBy                   String?
  dueDate                     DateTime?
  isShared                    Boolean             @default(false)
  reminderDate                DateTime?
  reminderTime                String?
  soundEnabled                Boolean             @default(true)
  completedAt                 DateTime?
  priority                    String              @default("MEDIUM")
  status                      String              @default("TODO")
  hrTimesheetId               String?
  complexity                  TaskComplexity      @default(MOYEN)
  trainingLevel               TrainingLevel?
  masteryLevel                MasteryLevel?
  understandingLevel          UnderstandingLevel?
  activityType                String?
  activityName                String?
  periodicity                 String?
  HRActivity                  HRActivity[]
  User_Task_createdByToUser   User?               @relation("Task_createdByToUser", fields: [createdBy], references: [id])
  User_Task_evaluatedByToUser User?               @relation("Task_evaluatedByToUser", fields: [evaluatedBy], references: [id])
  HRTimesheet                 HRTimesheet?        @relation(fields: [hrTimesheetId], references: [id])
  Task                        Task?               @relation("TaskToTask", fields: [parentId], references: [id])
  other_Task                  Task[]              @relation("TaskToTask")
  Project                     Project?            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  TaskActivity                TaskActivity[]
  TaskComment                 TaskComment[]
  TaskMember                  TaskMember[]

  @@index([activityType])
  @@index([complexity])
  @@index([createdBy])
  @@index([createdBy, status])
  @@index([dueDate])
  @@index([evaluatedBy])
  @@index([hrTimesheetId])
  @@index([isActive])
  @@index([parentId])
  @@index([priority])
  @@index([projectId])
  @@index([projectId, status])
  @@index([reminderDate])
  @@index([status])
  @@index([status, priority])
}

model TaskActivity {
  id          String   @id
  taskId      String
  userId      String
  action      String
  field       String?
  oldValue    String?
  newValue    String?
  description String?
  metadata    String?
  createdAt   DateTime @default(now())
  Task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([taskId])
  @@index([userId])
}

model TaskComment {
  id        String   @id
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime
  isEdited  Boolean  @default(false)
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([taskId])
  @@index([userId])
}

model TaskMember {
  id        String   @id
  taskId    String
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  Task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model User {
  id                                              String               @id
  email                                           String               @unique
  name                                            String
  role                                            Role                 @default(EMPLOYEE)
  avatar                                          String?
  departmentId                                    String?
  managerId                                       String?
  createdAt                                       DateTime             @default(now())
  updatedAt                                       DateTime
  emailVerified                                   Boolean              @default(false)
  image                                           String?
  enableTimesheetReminders                        Boolean              @default(true)
  reminderTime                                    String?              @default("17:00")
  reminderDays                                    String[]
  desktopNotificationsEnabled                     Boolean              @default(true)
  emailNotificationsEnabled                       Boolean              @default(true)
  notificationSoundEnabled                        Boolean              @default(true)
  notificationSoundType                           String               @default("default")
  notificationSoundVolume                         Float                @default(0.7)
  darkModeEnabled                                 Boolean              @default(true)
  accentColor                                     String               @default("rusty-red")
  viewDensity                                     String               @default("normal")
  fontSize                                        Int                  @default(12)
  language                                        String               @default("fr")
  dateFormat                                      String               @default("DD/MM/YYYY")
  hourFormat                                      String               @default("24")
  timezone                                        String               @default("Africa/Libreville")
  highContrast                                    Boolean              @default(false)
  screenReaderMode                                Boolean              @default(false)
  reduceMotion                                    Boolean              @default(false)
  weeklyGoal                                      Float                @default(40)
  Account                                         Account[]
  AuditLog                                        AuditLog[]
  Conversation                                    Conversation[]
  ConversationMember                              ConversationMember[]
  HRTimesheet_HRTimesheet_managerSignedByIdToUser HRTimesheet[]        @relation("HRTimesheet_managerSignedByIdToUser")
  HRTimesheet_HRTimesheet_odillonSignedByIdToUser HRTimesheet[]        @relation("HRTimesheet_odillonSignedByIdToUser")
  HRTimesheet_HRTimesheet_userIdToUser            HRTimesheet[]        @relation("HRTimesheet_userIdToUser")
  Message                                         Message[]
  Notification                                    Notification[]
  Project                                         Project[]
  ProjectMember                                   ProjectMember[]
  Report                                          Report[]
  ReportRecipient                                 ReportRecipient[]
  ReportTemplate                                  ReportTemplate[]
  Session                                         Session[]
  Task_Task_createdByToUser                       Task[]               @relation("Task_createdByToUser")
  Task_Task_evaluatedByToUser                     Task[]               @relation("Task_evaluatedByToUser")
  TaskActivity                                    TaskActivity[]
  TaskComment                                     TaskComment[]
  TaskMember                                      TaskMember[]
  Department                                      Department?          @relation(fields: [departmentId], references: [id])
  User                                            User?                @relation("UserToUser", fields: [managerId], references: [id])
  other_User                                      User[]               @relation("UserToUser")

  @@index([departmentId])
  @@index([email])
  @@index([managerId])
}

model Verification {
  id         String   @id
  identifier String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  updatedAt  DateTime
  value      String

  @@unique([identifier, value])
}

enum ConversationType {
  DIRECT
  GROUP
  PROJECT
}

enum HRActivityStatus {
  IN_PROGRESS
  COMPLETED
}

enum HRActivityType {
  OPERATIONAL
  REPORTING
}

enum HRPeriodicity {
  DAILY
  WEEKLY
  MONTHLY
  PUNCTUAL
  WEEKLY_MONTHLY
}

enum HRTimesheetStatus {
  DRAFT
  PENDING
  MANAGER_APPROVED
  APPROVED
  REJECTED
}

enum MasteryLevel {
  NOVICE
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ReportFrequency {
  WEEKLY
  MONTHLY
  INDIVIDUAL
}

enum Role {
  EMPLOYEE
  MANAGER
  HR
  ADMIN
  DIRECTEUR
}

enum TaskComplexity {
  FAIBLE
  MOYEN
  LEV_   @map("ÉLEVÉ")
}

enum TimeType {
  NORMAL
  OVERTIME
  NIGHT
  WEEKEND
}

enum TrainingLevel {
  NONE
  BASIC
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum UnderstandingLevel {
  NONE
  SUPERFICIAL
  WORKING
  COMPREHENSIVE
  EXPERT
}

