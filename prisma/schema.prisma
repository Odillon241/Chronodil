generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                    String    @id
  userId                String
  scope                 String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  accountId             String
  createdAt             DateTime  @default(now())
  idToken               String?
  password              String?
  providerId            String
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  updatedAt             DateTime
  User                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
}

model ActivityCatalog {
  id                 String         @id
  name               String         @unique
  category           String
  type               HRActivityType
  defaultPeriodicity HRPeriodicity?
  description        String?
  isActive           Boolean        @default(true)
  sortOrder          Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  HRActivity         HRActivity[]

  @@index([category])
  @@index([isActive])
  @@index([sortOrder])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([entityId])
  @@index([entity])
  @@index([userId])
}

model CompanySetting {
  id          String   @id
  key         String   @unique
  value       String
  type        String   @default("string")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([key])
}

model Conversation {
  id                 String               @id
  type               ConversationType
  name               String?
  projectId          String?
  createdBy          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  User               User?                @relation(fields: [createdBy], references: [id])
  Project            Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ConversationMember ConversationMember[]
  Message            Message[]

  @@index([createdAt])
  @@index([createdBy])
  @@index([projectId])
  @@index([type])
}

model ConversationMember {
  id             String       @id
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  isAdmin        Boolean      @default(false)
  isMuted        Boolean      @default(false)
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Department {
  id          String    @id
  name        String
  code        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Project     Project[]
  User        User[]

  @@index([code])
}

model HRActivity {
  id              String           @id
  hrTimesheetId   String
  activityType    HRActivityType
  activityName    String
  description     String?
  periodicity     HRPeriodicity
  weeklyQuantity  Int?
  startDate       DateTime
  endDate         DateTime
  totalHours      Float
  status          HRActivityStatus
  catalogId       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  ActivityCatalog ActivityCatalog? @relation(fields: [catalogId], references: [id])
  hrTimesheet     HRTimesheet      @relation("HRTimesheetActivities", fields: [hrTimesheetId], references: [id], onDelete: Cascade)

  @@index([catalogId])
  @@index([hrTimesheetId])
  @@index([status])
}

model HRTimesheet {
  id                   String            @id
  weekStartDate        DateTime
  weekEndDate          DateTime
  userId               String
  employeeName         String
  position             String
  site                 String
  totalHours           Float             @default(0)
  status               HRTimesheetStatus @default(DRAFT)
  employeeSignedAt     DateTime?
  managerSignedAt      DateTime?
  managerSignedById    String?
  odillonSignedAt      DateTime?
  odillonSignedById    String?
  employeeObservations String?
  managerComments      String?
  odillonComments      String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime
  activities           HRActivity[]      @relation("HRTimesheetActivities")
  ManagerSigner        User?             @relation("HRTimesheet_managerSignedByIdToUser", fields: [managerSignedById], references: [id])
  OdillonSigner        User?             @relation("HRTimesheet_odillonSignedByIdToUser", fields: [odillonSignedById], references: [id])
  User                 User              @relation("HRTimesheet_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate])
  @@index([managerSignedById])
  @@index([status])
  @@index([userId])
  @@index([weekStartDate])
}

model Holiday {
  id          String   @id
  name        String
  date        DateTime
  description String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([date, name])
  @@index([date])
}

model Message {
  id             String       @id
  conversationId String
  senderId       String
  content        String
  attachments    Json?
  isEdited       Boolean      @default(false)
  isDeleted      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  replyToId      String?
  reactions      Json?
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  Message        Message?     @relation("MessageToMessage", fields: [replyToId], references: [id])
  other_Message  Message[]    @relation("MessageToMessage")
  User           User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([replyToId])
  @@index([senderId])
}

model Notification {
  id        String   @id
  userId    String
  title     String
  message   String
  type      String   @default("info")
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([userId])
}

model Project {
  id             String           @id
  name           String
  code           String           @unique
  description    String?
  color          String           @default("#3b82f6")
  departmentId   String?
  budgetHours    Float?
  hourlyRate     Float?
  isActive       Boolean          @default(true)
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  createdBy      String?
  Conversation   Conversation[]
  User           User?            @relation(fields: [createdBy], references: [id])
  Department     Department?      @relation(fields: [departmentId], references: [id])
  ProjectMember  ProjectMember[]
  Task           Task[]
  TimesheetEntry TimesheetEntry[]

  @@index([code])
  @@index([createdBy])
  @@index([departmentId])
  @@index([isActive])
}

model ProjectMember {
  id        String   @id
  projectId String
  userId    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  Project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Report {
  id             String            @id
  title          String
  content        String
  format         String            @default("pdf") // "pdf" ou "word"
  period         String?
  includeSummary Boolean           @default(false)
  fileSize       Int               @default(0)
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  CreatedBy      User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  Recipients     ReportRecipient[]

  @@index([createdById])
  @@index([createdAt])
}

model ReportRecipient {
  id       String   @id
  reportId String
  userId   String?
  email    String
  name     String?
  status   String   @default("sent") // "sent", "pending", "failed"
  sentAt   DateTime @default(now())
  Report   Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  User     User?    @relation(fields: [userId], references: [id])

  @@index([reportId])
  @@index([userId])
  @@index([email])
}

model ReportType {
  id          String          @id
  name        String          @unique
  frequency   ReportFrequency
  description String?
  isActive    Boolean         @default(true)
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime

  @@index([frequency])
  @@index([isActive])
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Task {
  id             String           @id
  name           String
  description    String?
  projectId      String?
  parentId       String?
  estimatedHours Float?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Task           Task?            @relation("TaskToTask", fields: [parentId], references: [id])
  other_Task     Task[]           @relation("TaskToTask")
  Project        Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  TimesheetEntry TimesheetEntry[]

  @@index([isActive])
  @@index([parentId])
  @@index([projectId])
}

model TimesheetEntry {
  id                  String               @id
  userId              String
  projectId           String?
  taskId              String?
  date                DateTime
  startTime           DateTime?
  endTime             DateTime?
  duration            Float
  type                TimeType             @default(NORMAL)
  status              TimesheetStatus      @default(DRAFT)
  description         String?
  isLocked            Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  Project             Project?             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  Task                Task?                @relation(fields: [taskId], references: [id])
  User                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  TimesheetValidation TimesheetValidation?

  @@unique([userId, date, startTime])
  @@index([date])
  @@index([projectId])
  @@index([status])
  @@index([taskId])
  @@index([userId])
}

model TimesheetValidation {
  id               String          @id
  timesheetEntryId String          @unique
  validatorId      String
  status           TimesheetStatus
  comment          String?
  validatedAt      DateTime        @default(now())
  TimesheetEntry   TimesheetEntry  @relation(fields: [timesheetEntryId], references: [id], onDelete: Cascade)
  User             User            @relation(fields: [validatorId], references: [id])

  @@index([status])
  @@index([validatorId])
}

model User {
  id                       String                @id
  email                    String                @unique
  name                     String
  role                     Role                  @default(EMPLOYEE)
  avatar                   String?
  departmentId             String?
  managerId                String?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime
  emailVerified            Boolean               @default(false)
  image                    String?
  // Préférences de notification et rappel
  enableTimesheetReminders Boolean               @default(true)
  reminderTime             String?               @default("17:00") // Heure du rappel (HH:MM)
  reminderDays             String[]              @default(["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"]) // Jours de rappel
  Account                  Account[]
  AuditLog                 AuditLog[]
  Conversation             Conversation[]
  ConversationMember       ConversationMember[]
  HRTimesheetsAsManager    HRTimesheet[]         @relation("HRTimesheet_managerSignedByIdToUser")
  HRTimesheetsAsOdillon    HRTimesheet[]         @relation("HRTimesheet_odillonSignedByIdToUser")
  HRTimesheetsAsEmployee   HRTimesheet[]         @relation("HRTimesheet_userIdToUser")
  Message                  Message[]
  Notification             Notification[]
  Project                  Project[]
  ProjectMember            ProjectMember[]
  Report                   Report[]
  ReportRecipient          ReportRecipient[]
  Session                  Session[]
  TimesheetEntry           TimesheetEntry[]
  TimesheetValidation      TimesheetValidation[]
  Department               Department?           @relation(fields: [departmentId], references: [id])
  User                     User?                 @relation("UserToUser", fields: [managerId], references: [id])
  other_User               User[]                @relation("UserToUser")

  @@index([departmentId])
  @@index([email])
  @@index([managerId])
}

model Verification {
  id         String   @id
  identifier String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  updatedAt  DateTime
  value      String

  @@unique([identifier, value])
}

enum ConversationType {
  DIRECT
  GROUP
  PROJECT
}

enum HRActivityStatus {
  IN_PROGRESS
  COMPLETED
}

enum HRActivityType {
  OPERATIONAL
  REPORTING
}

enum HRPeriodicity {
  DAILY
  WEEKLY
  MONTHLY
  PUNCTUAL
  WEEKLY_MONTHLY
}

enum HRTimesheetStatus {
  DRAFT
  PENDING
  MANAGER_APPROVED
  APPROVED
  REJECTED
}

enum ReportFrequency {
  WEEKLY
  MONTHLY
  INDIVIDUAL
}

enum Role {
  EMPLOYEE
  MANAGER
  HR
  DIRECTEUR
  ADMIN
}

enum TimeType {
  NORMAL
  OVERTIME
  NIGHT
  WEEKEND
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  LOCKED
}
